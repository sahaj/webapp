<% provide(:title, @name) %>

<h1> <%= @name %> </h1>
<div class="container" id="Chart1" style="height: 400px; min-width: 500px"></div>
<div class="container" id="Chart2" style="height: 400px; min-width: 500px"></div>

<div class="container">
    <%= form_tag new_stock_path, method:'get', remote: true do |f|%>
    <%= text_field_tag :datepicker %>
    <%=submit_tag "Find Articles"%>
    <%end%>
</div>

<div id="articleform">

<script>
$(function() {
    var json_data = <%= raw @stock.to_json(only: [:date, :adjclose]) %>;
	var ar  = json_data.map(function(x){
		return [Date.parse(x.date), +x.adjclose];
	});
    ar.sort(sortFunction);

    var senti_data = <%= raw @sentiment.to_json(only: [:date, :sentiment]) %>;
    var senti_ar = senti_data.map(function(x){
        return [Date.parse(x.date), Math.round(+x.sentiment*100)/100];
    });
    senti_ar.sort(sortFunction);
    
    function sortFunction(a,b){
           return (a[0]<b[0]) ? -1:1;
    }

    //document.getElementById("demo").innerHTML = JSON.stringify(senti_data);
    $('#Chart1').highcharts('StockChart', {

        rangeSelector: {
            selected: 0
        },

        title: {
            text: 'Stock Price'
        },

        tooltip: {
            valueDecimals: 2,
            //valuePrefix: '$',
            valueSuffix: ' USD'
        },

        series: [{
            name: '<%= @name %>',
            data: ar,
            tooltip: {
                valueDecimals: 2
            }
        }]
    });

    $('#Chart2').highcharts('StockChart', {
            chart: {
                alignTicks: false,
                backgroundColor: {
                linearGradient: {
                    x1: 0,
                    y1: 0,
                    x2: 1,
                    y2: 1
                },
                stops: [
                    [0, 'rgb(255, 255, 255)'],
                    [1, 'rgb(255, 255, 255)']
                ]
                }
            },

            rangeSelector: {
                selected: 0
            },

            title: {
                text: 'Sentiment Values'
            },

            yAxis: {
                labels: {
                    align: 'right',
                    y: 0
                }
            },
            
            tooltip: {
            valueDecimals: 2,
            },

            series: [{
                type: 'column',
                name: 'Stock Sentiment',
                data: senti_ar,
                dataGrouping: {
                    approximation: 'sum', //showing sentiment sum for whole week
                    units: [[
                        'week',
                        [1]
                    ], [
                        'month',
                        [1, 3, 6]
                    ]]
                }
            }]
        });

});
</script>